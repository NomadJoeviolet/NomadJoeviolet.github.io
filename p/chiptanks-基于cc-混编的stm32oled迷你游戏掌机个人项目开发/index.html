<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="前言 非常适合集成各类库后去雕琢，练习 C&amp;C++混编和设计模式，C++动态内存分配等，很爽的练手项目\n项目代码状况\n1 2 3 4 5 6 7 8 9 10 11 12 13 Top-level groups: Bullet Raw= 378 NonEmpty= 304 Code= 266 Data Raw= 301 NonEmpty= 252 Code= 186 gameEntityManager.hpp Raw= 412 NonEmpty= 362 Code= 300 gamePerkCardManager.hpp Raw= 171 NonEmpty= 145 Code= 128 gameProgressManager.hpp Raw= 410 NonEmpty= 359 Code= 307 Peripheral Raw= 1624 NonEmpty= 1495 Code= 905 PerkCard Raw= 67 NonEmpty= 56 Code= 54 reload_new_delete.cpp Raw= 61 NonEmpty= 52 Code= 33 Role Raw= 3314 NonEmpty= 2865 Code= 2349 threads.cpp Raw= 259 NonEmpty= 219 Code= 140 Totals: RawLines=6997 NonEmptyLines=6109 CodeLines=4668 游戏设计 玩法介绍：ChipTanks-玩法介绍\n">
<title>ChipTanks-基于C&amp;C&#43;&#43;混编的STM32OLED迷你游戏掌机个人项目开发</title>

<link rel='canonical' href='https://NomadJoeviolet.github.io/p/chiptanks-%E5%9F%BA%E4%BA%8Ecc-%E6%B7%B7%E7%BC%96%E7%9A%84stm32oled%E8%BF%B7%E4%BD%A0%E6%B8%B8%E6%88%8F%E6%8E%8C%E6%9C%BA%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="ChipTanks-基于C&C++混编的STM32OLED迷你游戏掌机个人项目开发">
<meta property='og:description' content="前言 非常适合集成各类库后去雕琢，练习 C&amp;C++混编和设计模式，C++动态内存分配等，很爽的练手项目\n项目代码状况\n1 2 3 4 5 6 7 8 9 10 11 12 13 Top-level groups: Bullet Raw= 378 NonEmpty= 304 Code= 266 Data Raw= 301 NonEmpty= 252 Code= 186 gameEntityManager.hpp Raw= 412 NonEmpty= 362 Code= 300 gamePerkCardManager.hpp Raw= 171 NonEmpty= 145 Code= 128 gameProgressManager.hpp Raw= 410 NonEmpty= 359 Code= 307 Peripheral Raw= 1624 NonEmpty= 1495 Code= 905 PerkCard Raw= 67 NonEmpty= 56 Code= 54 reload_new_delete.cpp Raw= 61 NonEmpty= 52 Code= 33 Role Raw= 3314 NonEmpty= 2865 Code= 2349 threads.cpp Raw= 259 NonEmpty= 219 Code= 140 Totals: RawLines=6997 NonEmptyLines=6109 CodeLines=4668 游戏设计 玩法介绍：ChipTanks-玩法介绍\n">
<meta property='og:url' content='https://NomadJoeviolet.github.io/p/chiptanks-%E5%9F%BA%E4%BA%8Ecc-%E6%B7%B7%E7%BC%96%E7%9A%84stm32oled%E8%BF%B7%E4%BD%A0%E6%B8%B8%E6%88%8F%E6%8E%8C%E6%9C%BA%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/'>
<meta property='og:site_name' content='Nomad_violet'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='C&amp;C&#43;&#43;' /><meta property='article:tag' content='个人项目' /><meta property='article:published_time' content='2025-11-27T18:23:07&#43;08:00'/><meta property='article:modified_time' content='2025-11-27T18:23:07&#43;08:00'/>
<meta name="twitter:title" content="ChipTanks-基于C&C++混编的STM32OLED迷你游戏掌机个人项目开发">
<meta name="twitter:description" content="前言 非常适合集成各类库后去雕琢，练习 C&amp;C++混编和设计模式，C++动态内存分配等，很爽的练手项目\n项目代码状况\n1 2 3 4 5 6 7 8 9 10 11 12 13 Top-level groups: Bullet Raw= 378 NonEmpty= 304 Code= 266 Data Raw= 301 NonEmpty= 252 Code= 186 gameEntityManager.hpp Raw= 412 NonEmpty= 362 Code= 300 gamePerkCardManager.hpp Raw= 171 NonEmpty= 145 Code= 128 gameProgressManager.hpp Raw= 410 NonEmpty= 359 Code= 307 Peripheral Raw= 1624 NonEmpty= 1495 Code= 905 PerkCard Raw= 67 NonEmpty= 56 Code= 54 reload_new_delete.cpp Raw= 61 NonEmpty= 52 Code= 33 Role Raw= 3314 NonEmpty= 2865 Code= 2349 threads.cpp Raw= 259 NonEmpty= 219 Code= 140 Totals: RawLines=6997 NonEmptyLines=6109 CodeLines=4668 游戏设计 玩法介绍：ChipTanks-玩法介绍\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu6061761693284197515.png" width="300"
                            height="200" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Nomad_violet</a></h1>
            <h2 class="site-description">to feel,to experience</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://www.bilibili.com/'
                        target="_blank"
                        title="Biliili"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"> <path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z"></path> <path d="M8 3l2 3"></path> <path d="M16 3l-2 3"></path> <path d="M9 13v-2"></path> <path d="M15 11v2"></path> </svg> 
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#前言">前言</a></li>
    <li><a href="#游戏设计">游戏设计</a></li>
    <li><a href="#硬件选型">硬件选型</a></li>
    <li><a href="#开发工具链">开发工具链</a></li>
    <li><a href="#第三方库引入">第三方库引入</a></li>
    <li><a href="#代码实现">代码实现</a>
      <ol>
        <li><a href="#动态内存分配在嵌入式平台上的解决">动态内存分配在嵌入式平台上的解决</a></li>
        <li><a href="#项目文件结构">项目文件结构</a>
          <ol>
            <li><a href="#整体结构">整体结构</a></li>
            <li><a href="#app-结构">App 结构</a></li>
          </ol>
        </li>
        <li><a href="#架构与设计思路">架构与设计思路</a>
          <ol>
            <li><a href="#硬件抽象层">硬件抽象层</a></li>
            <li><a href="#核心数据层">核心数据层</a></li>
            <li><a href="#游戏实体层">游戏实体层</a></li>
            <li><a href="#管理器层">管理器层</a></li>
            <li><a href="#应用逻辑层">应用逻辑层</a></li>
          </ol>
        </li>
        <li><a href="#各层级和功能的代码实现与解析">各层级和功能的代码实现与解析</a>
          <ol>
            <li><a href="#硬件抽象层-1">硬件抽象层</a></li>
            <li><a href="#核心数据层-1">核心数据层</a></li>
            <li><a href="#游戏实体层-1">游戏实体层</a></li>
            <li><a href="#管理器层-1">管理器层</a></li>
            <li><a href="#应用逻辑层-1">应用逻辑层</a></li>
            <li><a href="#timer-定时器的设计">timer 定时器的设计</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/cc&#43;&#43;-study/" >
                C&amp;C&#43;&#43; Study
            </a>
        
            <a href="/categories/%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE/" >
                个人项目
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/chiptanks-%E5%9F%BA%E4%BA%8Ecc-%E6%B7%B7%E7%BC%96%E7%9A%84stm32oled%E8%BF%B7%E4%BD%A0%E6%B8%B8%E6%88%8F%E6%8E%8C%E6%9C%BA%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">ChipTanks-基于C&amp;C&#43;&#43;混编的STM32OLED迷你游戏掌机个人项目开发</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-11-27</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="前言">前言
</h2><p>非常适合集成各类库后去雕琢，练习 C&amp;C++混编和设计模式，C++动态内存分配等，很爽的练手项目</p>
<p>项目代码状况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Top-level groups:
</span></span><span class="line"><span class="cl">Bullet          Raw=   378 NonEmpty=   304 Code=   266
</span></span><span class="line"><span class="cl">Data            Raw=   301 NonEmpty=   252 Code=   186
</span></span><span class="line"><span class="cl">gameEntityManager.hpp Raw=   412 NonEmpty=   362 Code=   300
</span></span><span class="line"><span class="cl">gamePerkCardManager.hpp Raw=   171 NonEmpty=   145 Code=   128
</span></span><span class="line"><span class="cl">gameProgressManager.hpp Raw=   410 NonEmpty=   359 Code=   307
</span></span><span class="line"><span class="cl">Peripheral      Raw=  1624 NonEmpty=  1495 Code=   905
</span></span><span class="line"><span class="cl">PerkCard        Raw=    67 NonEmpty=    56 Code=    54
</span></span><span class="line"><span class="cl">reload_new_delete.cpp Raw=    61 NonEmpty=    52 Code=    33
</span></span><span class="line"><span class="cl">Role            Raw=  3314 NonEmpty=  2865 Code=  2349
</span></span><span class="line"><span class="cl">threads.cpp     Raw=   259 NonEmpty=   219 Code=   140
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Totals: RawLines=6997  NonEmptyLines=6109  CodeLines=4668
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="游戏设计">游戏设计
</h2><p>玩法介绍：<a class="link" href="https://nomadjoeviolet.github.io/p/chiptanks-%E7%8E%A9%E6%B3%95%E4%BB%8B%E7%BB%8D/"  target="_blank" rel="noopener"
    >ChipTanks-玩法介绍</a></p>
<p>游戏设计：<a class="link" href="https://nomadjoeviolet.github.io/p/chiptanks-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1/"  target="_blank" rel="noopener"
    >ChipTanks-游戏设计</a></p>
<h2 id="硬件选型">硬件选型
</h2><p>使用的 OLED 屏的显示驱动为 SSD1306
主控板为 stm32f103c8t6
使用 4 * 4 矩阵键盘</p>
<h2 id="开发工具链">开发工具链
</h2><p>使用 VSCode+Intellisence+CubeMX+CMake+Ninja+arm-none-eabi+Ozone+Jlink 的高自定义开发工具链</p>
<p>代码编辑器采用 VSCode，语言服务器使用 VSCode 的 Intellisence 来实现智能代码补全和理解功能，用 CubeMX 生成硬件抽象层代码，CMake 和 Ninja 作为项目构建工具，使用 arm-none-eabi 编译器，烧录和调试使用 Ozone，硬件烧录器使用 Jlink</p>
<p>CubeMX 使用的版本为<code>6.15.0</code>
CMake 使用的版本为<code>4.1.0</code>
编译器 arm-none-eabi 使用的版本为<code>14.3 rel1</code></p>
<p>开发方式采用 C&amp;C++混编，使用<code>exter &quot;C&quot; { }</code>解决 C++名词修饰导致 C 无法链接的问题，<code>extern &quot;C&quot;</code>的作用就是告诉 C++编译器修改符号表生成方式，将 C++符号的生成方式换成了的生成方式。</p>
<p>实践上将 FreeRTOS 的线程函数入口声明 定义为<code>As external</code></p>
<p><img src="/ChipTanks-keyScan%e7%ba%bf%e7%a8%8b.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>然后在<code>cpp</code>文件中去实现，实现的函数用<code>extern &quot;C&quot;</code>包裹即可，这样<code>void keyScanThread(void *argument)</code>经过 C++编译器编译后的符号就可以被 C 链接</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef __cplusplus
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">keyScanThread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">osDelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef __cplusplus
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="第三方库引入">第三方库引入
</h2><p>引入 FreeRTOS 和 dsp 库以及 etl 库</p>
<p>引入 FreeRTOS 用来处理多线程任务，引入 dsp 库用来加速部分运算（主要想用来加速 游戏实体 碰撞检测）（实际基本上没用，当做练手了），引入 etl 库来做到 零开销的使用 C++ 容器 提高开发效率，其确定性内存管理 (Deterministic Memory)在<strong>栈上</strong>或<strong>静态区</strong>分配固定大小的内存，而不是在堆上动态扩容，能完全避免了内存碎片问题，且内存占用在编译期就是已知的，非常适合 RAM 有限的 STM32，同时有容器去实现设计模式等会更加高效。</p>
<h2 id="代码实现">代码实现
</h2><h3 id="动态内存分配在嵌入式平台上的解决">动态内存分配在嵌入式平台上的解决
</h3><p>因嵌入式平台的内存资源非常有限，同时还要保证 FreeRTOS 的线程安全，需要对 C++的动态内存分配（<code>new</code>和<code>delete</code>）进行重载，重载为<code>pvPortMalloc(size)</code>和<code>vPortFree(ptr)</code>，FreeRTOS 线程安全的分配方式，从 FreeRTOS 的堆里面分配</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;FreeRTOS.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;task.h&#34;</span><span class="cp"> </span><span class="c1">// pvPortMalloc and vPortFree are defined here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp"> </span><span class="c1">// Use C header for size_t in embedded environments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="k">operator</span> <span class="nf">new</span><span class="p">(</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">pvPortMalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="k">operator</span> <span class="nf">delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">vPortFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="k">operator</span> <span class="k">new</span><span class="p">[](</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">pvPortMalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">[](</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">vPortFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="k">operator</span> <span class="nf">delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">size</span><span class="p">;</span> <span class="c1">// The size parameter is often unused in custom deallocations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">vPortFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">[](</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">vPortFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样重载后，动态分配的内存不会从 系统堆里面分配，而是从 FreeRTOS 的 <strong>静态 堆</strong>（内存池） （此处静态指 编译期最大容量确定）里面分配，从而避免可能的堆栈溢出，FreeRTOS 的堆栈管理方案采用 安全 且 有高效内存碎片化处理 的 heap4 即可</p>
<p><img src="/ChipTanks-FreeRTOS%e5%a0%86%e6%a0%88%e7%ae%a1%e7%90%86.png"
	
	
	
	loading="lazy"
	
	
></p>
<p><strong>为什么不使用系统堆？</strong></p>
<ol>
<li>因为在嵌入式实时操作系统中，调用 C 标准库中 malloc() 和 free() 是危险的，C++中的 new 和 delete 也一样：</li>
<li>这些函数在小型嵌入式系统中并不总是可用的，小型嵌入式设备中的 RAM 不足。</li>
<li>它们的实现可能非常的大，占据了相当大的一块代码空间。</li>
<li>他们几乎都不是线程安全的。</li>
<li>它们并不是确定的，每次调用这些函数执行的时间可能都不一样。</li>
<li>它们有可能产生内存碎片。</li>
<li>这两个函数会使得链接器配置得复杂。</li>
</ol>
<p>系统内存分配</p>
<p><img src="/ChipTanks-%e7%b3%bb%e7%bb%9fRAM%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d.png"
	
	
	
	loading="lazy"
	
	
>
<img src="/ChipTanks-FreeRTOS%e7%9a%84%e5%86%85%e5%ad%98%e5%b8%83%e5%b1%80.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>由此可以直接看出重载后动态内存分配可以保证系统栈和线程的安全</p>
<h3 id="项目文件结构">项目文件结构
</h3><h4 id="整体结构">整体结构
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">ChipTanks/
</span></span><span class="line"><span class="cl">├── App/                        // 游戏应用逻辑层
</span></span><span class="line"><span class="cl">│   ├── Bullet/                 // 子弹模块
</span></span><span class="line"><span class="cl">│   ├── Data/                   // 基础数据定义
</span></span><span class="line"><span class="cl">│   ├── Peripheral/             // 外设驱动（OLED, KEY）
</span></span><span class="line"><span class="cl">│   ├── PerkCard/               // 天赋卡片模块
</span></span><span class="line"><span class="cl">│   ├── Role/                   // 角色模块（玩家与敌人）
</span></span><span class="line"><span class="cl">│   ├── gameEntityManager.hpp   // 实体管理器
</span></span><span class="line"><span class="cl">│   ├── gamePerkCardManager.hpp // Perk管理器
</span></span><span class="line"><span class="cl">│   ├── gameProgressManager.hpp // 进度管理器
</span></span><span class="line"><span class="cl">│   ├── reload_new_delete.cpp   // 内存管理重载
</span></span><span class="line"><span class="cl">│   └── threads.cpp             // FreeRTOS任务定义
</span></span><span class="line"><span class="cl">├── ChipTanksPic/               // 项目图片资源（可能为空或存放设计图）
</span></span><span class="line"><span class="cl">├── Core/                       // STM32CubeMX 生成的核心代码
</span></span><span class="line"><span class="cl">│   ├── Inc/                    // 核心头文件 (main.h, FreeRTOSConfig.h 等)
</span></span><span class="line"><span class="cl">│   └── Src/                    // 核心源文件 (main.c, freertos.c, stm32f1xx_it.c 等)
</span></span><span class="line"><span class="cl">├── Drivers/                    // 硬件驱动库
</span></span><span class="line"><span class="cl">│   ├── CMSIS/                  // ARM Cortex 微控制器软件接口标准
</span></span><span class="line"><span class="cl">│   │   ├── Core/               // 核心外设访问层
</span></span><span class="line"><span class="cl">│   │   ├── DSP/                // 数字信号处理库 (DSP Lib)
</span></span><span class="line"><span class="cl">│   │   └── ...
</span></span><span class="line"><span class="cl">│   └── STM32F1xx_HAL_Driver/   // STM32F1系列 HAL 库驱动
</span></span><span class="line"><span class="cl">├── Lib/                        // 第三方库
</span></span><span class="line"><span class="cl">│   └── etl/                    // Embedded Template Library (嵌入式模板库)
</span></span><span class="line"><span class="cl">├── Middlewares/                // 中间件
</span></span><span class="line"><span class="cl">│   └── Third_Party/
</span></span><span class="line"><span class="cl">│       └── FreeRTOS/           // FreeRTOS 实时操作系统源码
</span></span><span class="line"><span class="cl">├── build/                      // 编译输出目录 (Debug/Release)
</span></span><span class="line"><span class="cl">├── cmake/                      // CMake 构建脚本与工具链配置
</span></span><span class="line"><span class="cl">├── CMakeLists.txt              // 项目根 CMake 配置文件
</span></span><span class="line"><span class="cl">└── STM32F103C8Tx_FLASH.ld      // 链接脚本
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="app-结构">App 结构
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">ChipTanks/App
</span></span><span class="line"><span class="cl">├── gameEntityManager.hpp       // 游戏实体管理器（管理所有角色和子弹）
</span></span><span class="line"><span class="cl">├── gamePerkCardManager.hpp     // Perk卡片管理器（管理升级抽卡逻辑）
</span></span><span class="line"><span class="cl">├── gameProgressManager.hpp     // 游戏进度管理器（管理关卡流程）
</span></span><span class="line"><span class="cl">├── reload_new_delete.cpp       // 重载C++内存分配（适配FreeRTOS）
</span></span><span class="line"><span class="cl">├── threads.cpp                 // FreeRTOS任务定义与调度
</span></span><span class="line"><span class="cl">├── Bullet/                     // 子弹模块
</span></span><span class="line"><span class="cl">│   ├── bullet.cpp              // 子弹逻辑实现
</span></span><span class="line"><span class="cl">│   └── bullet.hpp              // 子弹基类与派生类定义
</span></span><span class="line"><span class="cl">├── Data/                       // 数据模块
</span></span><span class="line"><span class="cl">│   └── basicData.hpp           // 基础数据结构与枚举定义
</span></span><span class="line"><span class="cl">├── Peripheral/                 // 外设驱动模块
</span></span><span class="line"><span class="cl">│   ├── KEY/
</span></span><span class="line"><span class="cl">│   │   ├── key.cpp             // 按键扫描实现
</span></span><span class="line"><span class="cl">│   │   └── key.hpp             // 按键接口定义
</span></span><span class="line"><span class="cl">│   └── OLED/
</span></span><span class="line"><span class="cl">│       ├── font.c              // 字库数据
</span></span><span class="line"><span class="cl">│       ├── font.h              // 字库声明
</span></span><span class="line"><span class="cl">│       ├── oled.c              // OLED驱动实现
</span></span><span class="line"><span class="cl">│       └── oled.h              // OLED接口定义
</span></span><span class="line"><span class="cl">├── PerkCard/                   // 天赋卡片模块
</span></span><span class="line"><span class="cl">│   └── prekCard.hpp            // Perk卡片类定义
</span></span><span class="line"><span class="cl">└── Role/                       // 角色模块
</span></span><span class="line"><span class="cl">    ├── enemyRole.cpp           // 敌人逻辑实现
</span></span><span class="line"><span class="cl">    ├── enemyRole.hpp           // 敌人派生类定义
</span></span><span class="line"><span class="cl">    ├── leadingrole.cpp         // 主角逻辑实现
</span></span><span class="line"><span class="cl">    ├── leadingRole.hpp         // 主角派生类定义
</span></span><span class="line"><span class="cl">    ├── role.cpp                // 角色基类逻辑实现
</span></span><span class="line"><span class="cl">    └── role.hpp                // 角色基类定义
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="架构与设计思路">架构与设计思路
</h3><p>主要采用 <strong>面向对象（OOP）</strong> 的设计思路，结合 FreeRTOS 实时操作系统，构建简单的嵌入式游戏框架。</p>
<p>主要分为 5 各层级：</p>
<ol>
<li>硬件抽象层：基于 HAL 库的对底层硬件的抽象，对外设硬件操作进行再次封装</li>
<li>核心数据层（Data）：定义游戏通用的数据结构和枚举</li>
<li>游戏实体层（Entity/Role）：定义角色(Role)基类和子弹(Bullet)基类 及其派生类</li>
<li>管理器层（Manager）：负责实体生命周期管理，碰撞检测，进度控制和 PerkSelection 系统</li>
<li>应用逻辑层（App Logic）：多线程任务处理，游戏业务逻辑</li>
</ol>
<h4 id="硬件抽象层">硬件抽象层
</h4><p>在 HAL 库基础上，对外设进行面向对象的进一步封装</p>
<p><strong>OLED</strong>(使用的 keysking 的开源库):
提供 OLED_DrawImage，OLED_PrintString 等绘图 API。
包含字库 (<code>font.c</code>)，支持文本显示。
作为游戏的<strong>输出设备</strong>，负责将游戏状态可视化。
<strong>KEY</strong>:
提供按键扫描逻辑。
作为游戏的<strong>输入设备</strong>，将物理按键映射为游戏内的控制信号</p>
<h4 id="核心数据层">核心数据层
</h4><p>定义了所有游戏实体共用的数据结构，如  <code>HealthData</code>（血量）、<code>AttackData</code>（攻击）、<code>SpatialData</code>（位置与大小）、<code>HeatData</code>（热量）等。
使用  <code>struct</code>  组合数据，便于在不同类之间传递和管理状态。
定义了  <code>RoleIdentity</code>（身份）、（子弹类型）等关键枚举。</p>
<h4 id="游戏实体层">游戏实体层
</h4><p>这是游戏逻辑的核心部分，采用了<strong>继承与多态</strong>的设计。</p>
<h5 id="基类设计"><strong>基类设计</strong>:
</h5><p><strong><code>IRole</code> （role.hpp</strong>）: 所有角色（玩家和敌人）的基类。包含  <code>RoleData</code>  指针，管理角色的所有属性。
定义了虚函数接口：<code>init()</code>, <code>think()</code>, <code>doAction()</code>, <code>drawRole()</code>, <code>die()</code>, <code>shoot()</code>。
实现了通用的物理逻辑：<code>move()</code>（移动与边界检查）、<code>update()</code>（状态更新）、<code>createBullet()</code>。</p>
<p><strong><code>IBullet</code> (bullet.hpp)</strong>: 所有子弹的基类。
定义了  <code>move()</code>, <code>update()</code>, <code>drawBullet()</code>, <code>die()</code>  等接口。</p>
<h5 id="派生类设计"><strong>派生类设计</strong>:
</h5><p><strong><code>LeadingRole</code> (<code>leadingRole.cpp</code>)</strong>: 玩家控制的主角。
实现了复杂的升级逻辑 (<code>levelUp</code>)、热量控制和多武器切换。
单例模式或全局对象管理（通常作为唯一主角存在）。</p>
<p><strong><code>EnemyRole</code> (<code>enemyRole.hpp</code>)</strong>: 各种敌人的实现。
<strong><code>FeilianEnemy</code></strong>: 高速骚扰型，只发普通弹。
<strong><code>TaotieEnemy</code></strong> (BOSS): 状态机控制的复杂行为（吞噬、冲撞）。
<strong><code>XiangliuEnemy</code></strong> (BOSS): 召唤与全屏弹幕。</p>
<p><strong><code>BasicBullet</code> / <code>FireBallBullet</code> / <code>LightningLineBullet</code></strong>: 不同类型的子弹实现，具有不同的伤害逻辑和特效。</p>
<h4 id="管理器层">管理器层
</h4><h5 id="1gameentitymanager-gameentitymanagerhpp">1.<strong><code>GameEntityManager</code> (<code>gameEntityManager.hpp</code>)</strong>:
</h5><p>核心职责:
维护所有活跃的角色和子弹容器，使用固定容量的嵌入式向量。包含角色池（最多 20 个）和子弹池（最多 100 个），以及游戏结束标记。提供注册新增实体、分阶段的行为与状态更新、碰撞与范围伤害检测、统一渲染、失效实体清理、获取主角指针和经验投递等功能。行为与状态分离，更新顺序通常为：角色行为、子弹行为、角色状态、子弹状态、清理、渲染。碰撞使用轴对齐包围盒，子弹碰撞允许穿透；范围伤害使用圆形距离判定。所有容器操作使用临界区保护以确保一致性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">	<span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IRole</span> <span class="o">*</span><span class="p">,</span> <span class="mi">20</span><span class="o">&gt;</span>    <span class="n">m_roles</span><span class="p">;</span>   <span class="c1">//角色池，存放所有角色指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IBullet</span> <span class="o">*</span><span class="p">,</span> <span class="mi">100</span><span class="o">&gt;</span> <span class="n">m_bullets</span><span class="p">;</span> <span class="c1">//子弹池，存放所有子弹指针
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>功能:</p>
<ol>
<li><code>addRole()</code>, <code>addBullet()</code>: 注册新实体。</li>
<li><code>updateAllRolesActions()</code>: 每帧调用所有角色的 <code>doAction()</code>。</li>
<li><code>updateAllRolesState()</code>：每帧调用所有角色的 <code>update()</code>。</li>
<li><code>checkxxxxCollision()</code>: 进行碰撞检测（AABB 碰撞盒），处理伤害结算。</li>
<li><code>drawAllRoles()</code>和<code>drawAllBullets</code>: 统一渲染所有实体。</li>
<li><code>cleanUpInvalidRoles()</code>和<code>cleanupInvalidBullets()</code>: 回收非活跃实体的内存，处理主角经验值获取。</li>
<li><code>getPlayerRole()</code>：获取主角的指针</li>
</ol>
<h5 id="2gameperkcardmanagergameperkcardmanagerhpp">2.<code>GamePerkCardManager</code> (<code>gamePerkCardManager.hpp</code>)
</h5><p>核心职责：
管理 Rogue-like 的随机强化流程，包括卡片仓库管理、抽取待选卡、选择应用以及未选卡回库。使用两个固定容量的嵌入式向量存储卡片仓库与选卡槽，并维护选卡状态、选中索引与数量。初始化时按配置表生成卡片；触发选卡会随机抽取最多三张并进入选卡状态；选择后将效果应用到玩家（如提高生命、攻击、攻速、移动速度、散热效率，或解锁火球与闪电，或提升范围与伤害倍率），随后将未选卡退回仓库并退出选卡状态。选卡界面显示卡名并有选中指示器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PerkCard</span><span class="p">,</span> <span class="n">MAX_CARD_COUNT</span><span class="o">&gt;</span>       <span class="n">m_cardWarehouse</span><span class="p">;</span>  <span class="c1">// 卡片仓库（存所有卡片）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PerkCard</span><span class="p">,</span> <span class="n">SELECTION_SLOT_COUNT</span><span class="o">&gt;</span> <span class="n">m_selectionSlots</span><span class="p">;</span> <span class="c1">// 选卡槽（临时存3张待选）
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>功能</p>
<ol>
<li><code>initWarehouse()</code>：初始化卡片仓库</li>
<li><code>triggerPerkSelection()</code>：触发<code>PerkSelection</code></li>
<li><code>selectCard</code>：选择卡片，同时将卡片效果应用</li>
<li><code>drawSelectionUI</code>：绘制选卡界面的 UI</li>
</ol>
<h5 id="3gameprogressmanagergameprogressmanagerhpp">3.<code>GameProgressManager</code> (<code>gameProgressManager.hpp</code>)
</h5><p>核心职责：
控制游戏整体流程，包括关卡推进、波次刷新、Boss 触发与展示、胜利/失败判定，以及开场/通关/警告等过场的展示与计时。与实体管理器和卡片管理器协作，驱动每一波敌人生成与选卡节点的触发。
功能</p>
<ol>
<li><code>resetGameProgress()</code>：重置整局流程，创建玩家实体并加入实体管理器，初始化卡片管理器仓库</li>
<li><code>updateGameProgress()</code>：推进波次/关卡与选卡触发，特定条件调用  <code>AddWaveEnemies()</code>  生成新的一波敌人</li>
<li><code>AddWaveEnemies()</code>：根据当前关卡与波次生成敌人阵型或 Boss</li>
<li><code>drawOpeningCG()</code>：绘制开场过场动画</li>
<li><code>drawClearCG()</code>：绘制通关动画</li>
<li><code>drawShowBoss()</code>：绘制 Boss 海报或挑战警告</li>
</ol>
<h4 id="应用逻辑层">应用逻辑层
</h4><p><code>threads.cpp</code>: 有三个核心任务线程来驱动整体逻辑</p>
<p><code>oledTaskThread</code>: 负责渲染时序。根据状态（开场、通关、Boss 展示、选卡、正常战斗）选择对应绘制路径；最终输出帧并控制刷新频率。
<code>keyScanThread</code>: 负责输入采集与分发。非选卡状态下更新玩家动作（上下左右）；选卡状态下移动 UI 光标并执行选中操作；根据游戏/过场状态决定是否响应按键。
<code>gameControlThread</code>: 负责主控流程与核心时序。Game Over 时重置游戏；正常状态下在非选卡与非过场时推进进度、执行实体行为与状态更新、清理无效实体。</p>
<h3 id="各层级和功能的代码实现与解析">各层级和功能的代码实现与解析
</h3><h4 id="硬件抽象层-1">硬件抽象层
</h4><h5 id="key">KEY
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef KEY_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEY_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;gpio.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_TypeDef</span><span class="o">*</span> <span class="n">GPIOx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">GPIO_Pin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">KeyGPIO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Key</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">m_keyButton</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="c1">//按键状态缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">KeyGPIO</span><span class="o">*</span> <span class="n">m_rankOutput</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">KeyGPIO</span><span class="o">*</span> <span class="n">m_colInput</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Key</span><span class="p">(</span><span class="n">KeyGPIO</span><span class="o">*</span> <span class="n">rankOutput</span><span class="p">,</span> <span class="n">KeyGPIO</span><span class="o">*</span> <span class="n">colInput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span><span class="n">m_rankOutput</span><span class="p">(</span><span class="n">rankOutput</span><span class="p">),</span> <span class="n">m_colInput</span><span class="p">(</span><span class="n">colInput</span><span class="p">){}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">Key</span><span class="p">(){};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//初始化行输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">m_rankOutput</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">m_rankOutput</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">GPIO_Pin</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">scan</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//拉低当前行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">m_rankOutput</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">m_rankOutput</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">GPIO_Pin</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//扫描列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="n">HAL_GPIO_ReadPin</span><span class="p">(</span><span class="n">m_colInput</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">m_colInput</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">GPIO_Pin</span><span class="p">)</span> <span class="o">==</span> <span class="n">GPIO_PIN_RESET</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m_keyButton</span><span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m_keyButton</span><span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//拉高当前行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">m_rankOutput</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">m_rankOutput</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">GPIO_Pin</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">Key</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// KEY_HPP
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;key.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">KeyGPIO</span> <span class="n">keyRankOutput</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_R1_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_R1_Pin</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_R2_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_R2_Pin</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_R3_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_R3_Pin</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_R4_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_R4_Pin</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">KeyGPIO</span> <span class="n">keyColInput</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_C1_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_C1_Pin</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_C2_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_C2_Pin</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_C3_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_C3_Pin</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">KEY_C4_GPIO_Port</span><span class="p">,</span> <span class="n">KEY_C4_Pin</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Key</span> <span class="nf">key</span><span class="p">(</span><span class="n">keyRankOutput</span><span class="p">,</span> <span class="n">keyColInput</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="oled">OLED
</h5><p>使用的是 keysking 的开源，该代码中提供 OLED 的驱动和绘画渲染的 API，直接使用即可</p>
<h4 id="核心数据层-1">核心数据层
</h4><p><strong>概览</strong>
定义了游戏所需的基础数据类型：身份、子弹类型、动作/移动/攻击/死亡/空间等数据结构，以及角色与子弹的数据聚合体。
“纯数据载体”，不含行为方法；行为由上层实体类与管理器驱动。
时间与数值单位采用“毫秒 + 小整型”为主，满足嵌入式 MCU 资源约束。
<strong>枚举类型</strong>
<code>RoleIdentity</code>: 标识阵营与身份（UNKNOWN/ENEMY/Player）。用于伤害互斥、经验结算等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"> <span class="k">enum</span> <span class="k">class</span> <span class="nc">RoleIdentity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ENEMY</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Player</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>BulletType</code>: 子弹种类（BASIC/FIRE_BALL/LIGHTNING_LINE）。影响碰
撞、穿越、范围与倍率等期望行为。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">BulletType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BASIC</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">FIRE_BALL</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">LIGHTNING_LINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ActionState</code>: 动作态（IDLE/MOVING/ATTACKING）。由输入或 AI 控制，驱动移动/攻击决策。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">ActionState</span> <span class="p">{</span> <span class="n">IDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOVING</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATTACKING</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>AttackMode</code>: 预留的攻击形态枚举（MODE_1…MODE_6），可用于多段或多式攻击切换。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">AttackMode</span> <span class="p">{</span> <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MODE_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MODE_2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MODE_3</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">MODE_4</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">,</span> <span class="n">MODE_5</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">,</span> <span class="n">MODE_6</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>MoveMode</code>: 移动方向（NONE/UP/DOWN/LEFT/RIGHT）。
<code>CollisionDirection</code>: 碰撞方向（NONE/LEFT/RIGHT/UP/DOWN），供状态响应/回退使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">MoveMode</span> <span class="p">{</span> <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">UP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DOWN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LEFT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">RIGHT</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>HeatData（热量数据）</strong>
变量：<code>currentHeat</code>，<code>maxHeat</code>，<code>heatCoolDownRate</code>，<code>heatCoolDownTimer</code>，<code>heatPerShot</code>。
构造：可用构造函数设置“初值、上限、冷却速率、每枪增量”。默认不显式初始化  <code>heatCoolDownTimer</code>（保持 0 即可）。
用法：开火前检查  <code>currentHeat + heatPerShot &lt;= maxHeat</code>；每帧/每周期按  <code>heatCoolDownRate</code>  降温（受  <code>heatCoolDownTimer</code>  和节拍控制）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HeatData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">currentHeat</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">maxHeat</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">heatCoolDownRate</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">heatCoolDownTimer</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">heatPerShot</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HeatData</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HeatData</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">current</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">max</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">coolDownRate</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">perShot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">currentHeat</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">maxHeat</span><span class="p">(</span><span class="n">max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">heatCoolDownRate</span><span class="p">(</span><span class="n">coolDownRate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">heatPerShot</span><span class="p">(</span><span class="n">perShot</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>HealthData（生命与回复）</strong>
变量：<code>currentHealth</code>，<code>maxHealth</code>，<code>healValue</code>，<code>healTimeCounter</code>，<code>healResetTime</code>，<code>healSpeed</code>。
语义：每  <code>healResetTime / healSpeed</code>  毫秒回复  <code>healValue</code>  点；<code>healTimeCounter</code>  为内部累加计时。
默认值：最大/当前 100，<code>healValue=3</code>，<code>healResetTime=15000ms</code>，<code>healSpeed=5</code>（等效更高频率）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 血量数据结构体
</span></span></span><span class="line"><span class="cl"><span class="c1">// 每隔一段时间自动回复一定量的血量
</span></span></span><span class="line"><span class="cl"><span class="c1">// 每 healResetTime/healSpeed 毫秒回复 healValue 点血量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">HealthData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">currentHealth</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">maxHealth</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span>  <span class="n">healValue</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">healTimeCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">healResetTime</span>   <span class="o">=</span> <span class="mi">15000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span>  <span class="n">healSpeed</span>       <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>SpatialMovementData（空间与移动）</strong>
变量：<code>canCrossBorder</code>，<code>consecutiveCollisionCount</code>，<code>moveSpeed</code>（int8），<code>currentPosX/Y</code>，<code>refPosX/Y</code>，<code>sizeX/Y</code>。
构造：可一次性设置“是否可越界、速度、当前位置/参考位置、尺寸”。
语义：
<code>currentPos</code>：实际显示/碰撞后的生效位置。
<code>refPos</code>：预期位置（用于先计算再做碰撞回退）。
<code>consecutiveCollisionCount</code>：连续碰撞计数，可用于卡边/弹跳等处理。
<code>canCrossBorder</code>：是否允许越界飞行（闪电线之类特种弹可开启）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 空间移动数据结构体
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @note  包含位置尺寸和移动速度
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param moveSpeed 移动速度
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param currentPosX 初始X位置，是物体左上角的X坐标
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param currentPosY 初始Y位置，是物体左上角的Y坐标
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param refPosX 参考X位置，用于碰撞检测后的回退
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param refPosY 参考Y位置，用于碰撞检测后的回退
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param sizeX 宽度
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param sizeY 高度
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SpatialMovementData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//能否穿越边界
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">canCrossBorder</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//连续触发碰撞次数（用来碰撞检测后的处理）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">consecutiveCollisionCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//移动速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int8_t</span> <span class="n">moveSpeed</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//位置尺寸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int16_t</span> <span class="n">currentPosX</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int16_t</span> <span class="n">currentPosY</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int16_t</span> <span class="n">refPosX</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int16_t</span> <span class="n">refPosY</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">sizeX</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">sizeY</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">SpatialMovementData</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @brief 构造函数
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param speed 移动速度，可以取负值表示反方向移动
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param currentPosX 现在X位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param currentPosY 现在Y位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param refPosX 期望X位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param refPosY 期望Y位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param sx 宽度
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param sy 高度
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SpatialMovementData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">canCrossBorder</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">refPosX</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">refPosY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span> <span class="n">sx</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">sy</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">canCrossBorder</span><span class="p">(</span><span class="n">canCrossBorder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">moveSpeed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">currentPosX</span><span class="p">(</span><span class="n">currentPosX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">currentPosY</span><span class="p">(</span><span class="n">currentPosY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">refPosX</span><span class="p">(</span><span class="n">refPosX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">refPosY</span><span class="p">(</span><span class="n">refPosY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">sizeX</span><span class="p">(</span><span class="n">sx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">sizeY</span><span class="p">(</span><span class="n">sy</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>RoleAttackData（攻击参数）</strong>
字段：<code>shootSpeed</code>，<code>shootCooldownTimer</code>，<code>shootCooldownResetTime</code>，<code>shootCooldownSpeed</code>，<code>attackPower</code>，<code>collisionPower</code>，<code>bulletSpeed</code>，<code>bulletRange</code>，<code>bulletDamageMultiplier</code>。
语义：
冷却体系：开火将  <code>shootCooldownTimer</code>  置为  <code>shootCooldownResetTime</code>，随后按帧减速（受  <code>shootCooldownSpeed</code>  影响）；计时至 0 才可再开火。
<code>attackPower</code>：子弹/技能的基础伤害。
<code>collisionPower</code>：实体体撞造成的伤害。
<code>bulletSpeed</code>/<code>bulletRange</code>/<code>bulletDamageMultiplier</code>：子弹飞行速度、范围（火球类有效）、伤害倍率（闪电链类有效）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RoleAttackData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//攻击速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span>  <span class="n">shootSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">shootCooldownTimer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">shootCooldownResetTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span>  <span class="n">shootCooldownSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//攻击力
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">attackPower</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">collisionPower</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//子弹速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int8_t</span> <span class="n">bulletSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//子弹伤害范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">bulletRange</span><span class="p">;</span><span class="c1">//只对火球弹生效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//子弹伤害倍率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">float</span> <span class="n">bulletDamageMultiplier</span><span class="p">;</span><span class="c1">//只对闪电链弹生效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>InitData（初始化）</strong>
变量：<code>isInited</code>，<code>posX/posY</code>，<code>init_count</code>。
用法：实体首次加入场景时从此读取出生点/初始状态；<code>isInited</code>控制是否进入正常逻辑。</p>
<p><strong>ActionData（动作控制）</strong>
变量：<code>currentState</code>，<code>attackMode</code>，<code>moveMode</code>。
用法：由输入或 AI 写入；逻辑层依据其驱动运动与攻击。</p>
<p><strong>DeathData（死亡信息）</strong>
变量：<code>isDead</code>，<code>deathTimer</code>（默认 500ms），<code>dropExperiencePoints</code>。
用法：死亡后倒计时播放动画；清理阶段根据阵营发经验（由管理器处理）。</p>
<p><strong>RoleData（角色聚合体）</strong>
聚合：<code>InitData</code>、<code>RoleIdentity</code>、<code>isActive</code>、<code>DeathData</code>、<code>ActionData</code>、<code>HealthData</code>、<code>level</code>、<code>HeatData</code>、<code>RoleAttackData</code>、<code>SpatialMovementData</code>、<code>img</code>。
默认构造初始化要点：
身份 UNKNOWN、<code>isActive=false</code>、<code>level=1</code>。
生命/热量/攻击参数设了合理初值：最大生命 100；热量上限 100、每枪+10、冷却速率 10；冷却重置 1000ms；攻 10/撞 5；子弹速度 1；火球范围 1；闪电倍率 1.5。
空间数据初始移动速度 1，位置/尺寸 0。
<code>img=nullptr</code>（注释明确“此处易出错，若有问题优先检查”）。
典型交互：
管理器在更新状态前用  <code>refPos</code>  做碰撞探测，结果再更新  <code>currentPos</code>。
玩家升级逻辑在管理器的状态更新阶段主动调用（基于  <code>experiencePoints</code>  等外部字段，非此处）。
Perk 卡片直接修改  <code>RoleData</code>内子段（例如血量上限、射速、热量、移动等）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RoleData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//初始化位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InitData</span> <span class="n">initData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//基本信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RoleIdentity</span> <span class="n">identity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span>         <span class="n">isActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//死亡状态信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DeathData</span> <span class="n">deathData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//动作信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ActionData</span> <span class="n">actionData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//血量信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HealthData</span> <span class="n">healthData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//等级信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//热量信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HeatData</span> <span class="n">heatData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//攻击信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RoleAttackData</span> <span class="n">attackData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//空间移动信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SpatialMovementData</span> <span class="n">spatialData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//图片信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">Image</span> <span class="o">*</span><span class="n">img</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span> <span class="c1">//易出错的地方，有问题优先检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//角色图片，指向同一片内存，利用浅拷贝的特性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">RoleData</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">identity</span> <span class="o">=</span> <span class="n">RoleIdentity</span><span class="o">::</span><span class="n">UNKNOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//初始化信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">initData</span><span class="p">.</span><span class="n">posX</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">initData</span><span class="p">.</span><span class="n">posY</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">initData</span><span class="p">.</span><span class="n">init_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//血量信息初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span>   <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">healthData</span><span class="p">.</span><span class="n">maxHealth</span>       <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">healthData</span><span class="p">.</span><span class="n">healValue</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">healthData</span><span class="p">.</span><span class="n">healTimeCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">healthData</span><span class="p">.</span><span class="n">healResetTime</span>   <span class="o">=</span> <span class="mi">15000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">healthData</span><span class="p">.</span><span class="n">healSpeed</span>       <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//等级初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//热量信息初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">heatData</span> <span class="o">=</span> <span class="n">HeatData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//射击后，cooldown计时器增加，只有当计时器达到0时才能再次射击
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">attackData</span><span class="p">.</span><span class="n">shootSpeed</span>             <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownTimer</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownSpeed</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">attackData</span><span class="p">.</span><span class="n">attackPower</span>            <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">attackData</span><span class="p">.</span><span class="n">collisionPower</span>         <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownResetTime</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// Added initialization for shootCooldownResetTime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//子弹速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">attackData</span><span class="p">.</span><span class="n">bulletSpeed</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//火球弹伤害范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">attackData</span><span class="p">.</span><span class="n">bulletRange</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//闪电链伤害倍率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">attackData</span><span class="p">.</span><span class="n">bulletDamageMultiplier</span> <span class="o">=</span> <span class="mf">1.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//空间移动信息初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">spatialData</span> <span class="o">=</span> <span class="n">SpatialMovementData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//死亡状态信息初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">deathData</span><span class="p">.</span><span class="n">deathTimer</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">deathData</span><span class="p">.</span><span class="n">isDead</span>     <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">deathData</span><span class="p">.</span><span class="n">dropExperiencePoints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//图片信息初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">img</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>BulletData（子弹聚合体）</strong>
聚合：<code>fromIdentity</code>（默认 UNKNOWN）、<code>DeathData</code>、<code>SpatialMovementData</code>、<code>damage</code>、<code>range</code>、<code>type</code>、<code>isActive</code>、<code>img</code>。
构造函数（重载二）：
默认构造：不做初始化。
参数构造：
参数：<code>speed</code>，<code>currentPosX/Y</code>，<code>dmg</code>，<code>rg</code>，<code>type</code>，<code>dmgMultiplier=1.0f</code>。
逻辑：按  <code>type</code>  分支设置  <code>damage</code>、<code>spatialData</code>、<code>isActive=true</code>、<code>range=rg</code>；<code>LIGHTNING_LINE</code>  设为  <code>canCrossBorder=true</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BulletData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//来自
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RoleIdentity</span> <span class="n">fromIdentity</span><span class="p">{</span><span class="n">RoleIdentity</span><span class="o">::</span><span class="n">UNKNOWN</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//死亡信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DeathData</span> <span class="n">deathData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//空间移动信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SpatialMovementData</span> <span class="n">spatialData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//伤害值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">damage</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">range</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//子弹类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BulletType</span> <span class="n">type</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//是否激活
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">isActive</span><span class="p">{</span><span class="nb">true</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//图片信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">Image</span> <span class="o">*</span><span class="n">img</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">BulletData</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BulletData</span><span class="p">(</span><span class="kt">int8_t</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">dmg</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">rg</span><span class="p">,</span> <span class="n">BulletType</span> <span class="n">type</span> <span class="p">,</span> <span class="kt">float</span> <span class="n">dmgMultiplier</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//根据类型进行初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">BulletType</span><span class="o">::</span><span class="nl">BASIC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//img = &amp;bulletImg;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">damage</span> <span class="o">=</span> <span class="n">dmg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">spatialData</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">SpatialMovementData</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">isActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">range</span>    <span class="o">=</span> <span class="n">rg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">BulletType</span><span class="o">::</span><span class="nl">FIRE_BALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//img = &amp;fireBallImg;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">damage</span> <span class="o">=</span> <span class="n">dmg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">spatialData</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">SpatialMovementData</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">isActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">range</span>    <span class="o">=</span> <span class="n">rg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">BulletType</span><span class="o">::</span><span class="nl">LIGHTNING_LINE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//img = &amp;lightningLineImg;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">damage</span> <span class="o">=</span> <span class="n">dmg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">spatialData</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">SpatialMovementData</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="n">currentPosX</span><span class="p">,</span> <span class="n">currentPosY</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">isActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">range</span>    <span class="o">=</span> <span class="n">rg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="游戏实体层-1">游戏实体层
</h4><p>实体层以抽象的角色基类为核心，所有角色共享一套数据驱动的状态与行为流程：初始化、决策、执行、推进与渲染。</p>
<p>玩家与敌人分别在其派生类中实现具体的思考与行动——玩家由输入驱动，敌人由定时与模式切换驱动。当角色需要开火时，通过角色基类提供的子弹工厂按类型生成不同机制的弹药：普通弹以基础伤害直击，火球弹在直击之外叠加范围溅射，闪电链以倍数加成的穿透伤害形成压制。</p>
<p>角色推进采用“参考位置 + 碰撞回退”的模式：先根据移动意图计算参考坐标，再用轴对齐包围盒检测并按碰撞方向和连续碰撞次数逐步回退，避免卡边。</p>
<p>数值系统围绕冷却、热量和回血三条独立的时序通道运行：冷却按步长与速度递减至零方可再次射击，热量每固定周期按散热速率衰减，回血以计时器触发离散恢复。</p>
<p>所有实体的创建、更新、碰撞与回收由实体管理器统一编排，管理器在行为与状态阶段之间明确分离职责：先让角色与子弹各自做决策与动作，再推进位置与伤害结算，随后清理失效对象并为玩家结算经验，最后渲染画面。</p>
<p>整体以固定容量的嵌入式容器与临界区保护保证在资源受限与多任务环境下的确定性与安全性，同时通过将机制落在数据结构上，保留足够的可调性与扩展空间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef ROLE_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ROLE_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;basicData.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;bullet.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;etl/algorithm.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">uint8_t</span> <span class="n">controlDelayTime</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 角色接口类
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @note 所有角色类均需继承该接口类
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @note think()函数用于实现AI逻辑，决定Action状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IRole</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">RoleData</span><span class="o">*</span> <span class="n">m_pdata</span> <span class="o">=</span> <span class="k">nullptr</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">IRole</span><span class="p">()</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">m_pdata</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RoleData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="o">~</span><span class="n">IRole</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">m_pdata</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="p">[]</span> <span class="n">m_pdata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">RoleData</span><span class="o">*</span> <span class="n">getData</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">m_pdata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">shoot</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">x</span> <span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">y</span> <span class="p">,</span> <span class="n">BulletType</span> <span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">doAction</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">die</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">think</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">drawRole</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 画角色函数声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IBullet</span><span class="o">*</span> <span class="nf">createBullet</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">x</span> <span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">y</span> <span class="p">,</span> <span class="n">BulletType</span> <span class="n">type</span> <span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">move</span><span class="p">(</span><span class="kt">int8_t</span> <span class="n">dirX</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">dirY</span> <span class="p">,</span> <span class="kt">bool</span> <span class="n">ignoreSpeed</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">CollisionResult</span> <span class="n">collisionResult</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">takeDamage</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">damage</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">isActive</span><span class="p">()</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// ROLE_HPP
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>实现上仅重点展示<code>update()</code>函数，该函数会在<code>GameEntityManager</code>中调用，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">IRole</span><span class="o">::</span><span class="n">update</span><span class="p">(</span><span class="n">CollisionResult</span> <span class="n">collisionResult</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">initData</span><span class="p">.</span><span class="n">isInited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//首次初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">deathData</span><span class="p">.</span><span class="n">isDead</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">die</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//位置更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">collisionResult</span><span class="p">.</span><span class="n">isCollision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">currentPosX</span> <span class="o">=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">currentPosY</span> <span class="o">=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosX</span> <span class="o">=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">currentPosX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosY</span> <span class="o">=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">currentPosY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//碰撞处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//碰撞处理在位置更新后进行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">collisionResult</span><span class="p">.</span><span class="n">isCollision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//用来避免单次碰撞一次退回的无法解决碰撞的问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">consecutiveCollisionCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//碰撞后退回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint8_t</span> <span class="n">backStep</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">consecutiveCollisionCount</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">identity</span> <span class="o">==</span> <span class="n">RoleIdentity</span><span class="o">::</span><span class="n">Player</span><span class="p">)</span> <span class="n">backStep</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">consecutiveCollisionCount</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">collisionResult</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">CollisionDirection</span><span class="o">::</span><span class="n">LEFT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosX</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosX</span> <span class="o">-</span> <span class="n">backStep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">collisionResult</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">CollisionDirection</span><span class="o">::</span><span class="n">RIGHT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosX</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">etl</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosX</span> <span class="o">+</span> <span class="n">backStep</span><span class="p">,</span> <span class="mi">128</span> <span class="o">-</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">sizeX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">collisionResult</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">CollisionDirection</span><span class="o">::</span><span class="n">UP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosY</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosY</span> <span class="o">-</span> <span class="n">backStep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">collisionResult</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">CollisionDirection</span><span class="o">::</span><span class="n">DOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosY</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">etl</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">refPosY</span> <span class="o">+</span> <span class="n">backStep</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">sizeY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">consecutiveCollisionCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//射击冷却处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownTimer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span> <span class="n">shootCooldownSpeed</span> <span class="o">=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">controlDelayTime</span> <span class="o">*</span> <span class="n">shootCooldownSpeed</span> <span class="o">&gt;=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownTimer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownTimer</span> <span class="o">-=</span> <span class="n">controlDelayTime</span> <span class="o">*</span> <span class="n">shootCooldownSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//热量冷却处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">currentHeat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">heatCoolDownTimer</span> <span class="o">+=</span> <span class="n">controlDelayTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">heatCoolDownTimer</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="c1">//每200ms降温一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">currentHeat</span> <span class="o">&lt;=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">heatCoolDownRate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">currentHeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">currentHeat</span> <span class="o">-=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">heatCoolDownRate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">heatCoolDownTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//回血处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span> <span class="o">&lt;</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">maxHealth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healTimeCounter</span> <span class="o">+=</span> <span class="n">controlDelayTime</span> <span class="o">*</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healTimeCounter</span> <span class="o">&gt;=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healResetTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span> <span class="o">+</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healValue</span> <span class="o">&gt;=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">maxHealth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span> <span class="o">=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">maxHealth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span> <span class="o">+=</span> <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healTimeCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//检查血量状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">deathData</span><span class="p">.</span><span class="n">isDead</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_pdata</span><span class="o">-&gt;</span><span class="n">deathData</span><span class="p">.</span><span class="n">isDead</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其余代码就不展示了，基本就是复制，只需根据需求对虚接口进行重写即可</p>
<h4 id="管理器层-1">管理器层
</h4><p><strong>该层级的设计主要是针对整个游戏运行的职责进行划分解耦</strong>，<code>GameEntityManager</code>,<code>GameProgressManager</code>,<code>GamePerkCardManager</code>三者协作的关键在于清晰的职责边界与状态门控：进度与选卡控制何时推进逻辑或暂停到过场/选卡，实体管理器提供确定性更新与资源回收，卡片管理器以数据驱动改变玩家的 RoleData</p>
<p><code>GameEntityManager</code>统一掌控角色与子弹的生命周期与时序，采用固定容量的嵌入式向量存储多态指针，所有增删与遍历在临界区内执行，按“行动 → 状态 → 清理 → 渲染”的分阶段流程驱动：行动阶段调用角色/子弹的思考与动作，状态阶段推进位置与 AABB 碰撞、伤害与范围伤害并对玩家执行升级检查，清理阶段删除失效实体并向玩家结算经验，渲染阶段输出图像。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef GAMEENTITYMANAGER_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GAMEENTITYMANAGER_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;math.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;role.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;leadingRole.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;enemyRole.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;etl/vector.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;FreeRTOS.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;task.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 管理游戏中的实体：角色和子弹
</span></span></span><span class="line"><span class="cl"><span class="c1">// 会被多个模块引用
</span></span></span><span class="line"><span class="cl"><span class="c1">// 归gameProgressManager管理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">GameEntityManager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IRole</span> <span class="o">*</span><span class="p">,</span> <span class="mi">20</span><span class="o">&gt;</span>    <span class="n">m_roles</span><span class="p">;</span>   <span class="c1">//角色池，存放所有角色指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IBullet</span> <span class="o">*</span><span class="p">,</span> <span class="mi">100</span><span class="o">&gt;</span> <span class="n">m_bullets</span><span class="p">;</span> <span class="c1">//子弹池，存放所有子弹指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span>                       <span class="n">isGameOver</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">GameEntityManager</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">GameEntityManager</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanUpAllRoles</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanUpAllBullets</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">GameEntityManager</span><span class="p">(</span><span class="k">const</span> <span class="n">GameEntityManager</span> <span class="o">&amp;</span><span class="p">)</span>            <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GameEntityManager</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">GameEntityManager</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Add添加/********************************************************************/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">addRole</span><span class="p">(</span><span class="n">IRole</span> <span class="o">*</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">m_roles</span><span class="p">.</span><span class="n">full</span><span class="p">())</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_roles</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">role</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">addBullet</span><span class="p">(</span><span class="n">IBullet</span> <span class="o">*</span><span class="n">bullet</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bullet</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">m_bullets</span><span class="p">.</span><span class="n">full</span><span class="p">())</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_bullets</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bullet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//remove删除并销毁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">removeAndDestroyRole</span><span class="p">(</span><span class="n">IRole</span> <span class="o">*</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">m_roles</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">m_roles</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">role</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">m_roles</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_roles</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">role</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">removeAndDestroyBullet</span><span class="p">(</span><span class="n">IBullet</span> <span class="o">*</span><span class="n">bullet</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bullet</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">m_bullets</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">m_bullets</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">bullet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">m_bullets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_bullets</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">bullet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取player角色指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IRole</span> <span class="o">*</span><span class="nf">getPlayerRole</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">role</span> <span class="p">:</span> <span class="n">m_roles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">role</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">identity</span> <span class="o">==</span> <span class="n">RoleIdentity</span><span class="o">::</span><span class="n">Player</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">role</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//清除需要回收的角色和子弹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">cleanupInvalidRoles</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">cleanupInvalidBullets</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//碰撞检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="n">CollisionResult</span> <span class="nf">checkRoleRefPositionCollision</span><span class="p">(</span><span class="n">IRole</span> <span class="o">*</span><span class="n">role_A</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">collisionDetected</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">checkBulletRefPositionCollision</span><span class="p">(</span><span class="n">IBullet</span> <span class="o">*</span><span class="n">bullet_A</span><span class="p">)</span> <span class="p">{</span>	        <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">collisionDetected</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//子弹范围伤害检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">checkBulletRangeDamage</span><span class="p">(</span><span class="n">IBullet</span> <span class="o">*</span><span class="n">bullet_A</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//更新所有实体位置和状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @brief 更新所有角色状态和位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">updateAllRolesState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">rolePtr</span> <span class="p">:</span> <span class="n">m_roles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">rolePtr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">CollisionResult</span> <span class="n">collisionResult</span> <span class="o">=</span> <span class="p">{</span><span class="nb">false</span><span class="p">,</span> <span class="n">CollisionDirection</span><span class="o">::</span><span class="n">NONE</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">initData</span><span class="p">.</span><span class="n">isInited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//碰撞处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">collisionResult</span> <span class="o">=</span> <span class="n">checkRoleRefPositionCollision</span><span class="p">(</span><span class="n">rolePtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">collisionResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">identity</span> <span class="o">==</span> <span class="n">RoleIdentity</span><span class="o">::</span><span class="n">Player</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LeadingRole</span><span class="o">*</span> <span class="n">playerRole</span> <span class="o">=</span> <span class="p">(</span><span class="n">LeadingRole</span><span class="o">*</span><span class="p">)</span><span class="n">rolePtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">playerRole</span><span class="o">-&gt;</span><span class="n">levelUp</span><span class="p">();</span> <span class="c1">//检查升级
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @brief 更新所有子弹状态和位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">updateAllBulletsState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bulletPtr</span> <span class="p">:</span> <span class="n">m_bullets</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">bulletPtr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">CollisionResult</span> <span class="n">collisionResult</span> <span class="o">=</span> <span class="p">{</span><span class="nb">false</span><span class="p">,</span> <span class="n">CollisionDirection</span><span class="o">::</span><span class="n">NONE</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//碰撞处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">bool</span> <span class="n">isCollision</span> <span class="o">=</span> <span class="n">checkBulletRefPositionCollision</span><span class="p">(</span><span class="n">bulletPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">isCollision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">collisionResult</span><span class="p">.</span><span class="n">isCollision</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">checkBulletRangeDamage</span><span class="p">(</span><span class="n">bulletPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">bulletPtr</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">collisionResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新所有角色的AI行动决策
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">updateAllRolesActions</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">rolePtr</span> <span class="p">:</span> <span class="n">m_roles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">rolePtr</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">initData</span><span class="p">.</span><span class="n">isInited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">think</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">doAction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">updateAllBulletsActions</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bulletPtr</span> <span class="p">:</span> <span class="n">m_bullets</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">bulletPtr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bulletPtr</span><span class="o">-&gt;</span><span class="n">doAction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 绘制所有实体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">drawAllRoles</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">rolePtr</span> <span class="p">:</span> <span class="n">m_roles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">rolePtr</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">img</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rolePtr</span><span class="o">-&gt;</span><span class="n">drawRole</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">drawAllBullets</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskENTER_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bulletPtr</span> <span class="p">:</span> <span class="n">m_bullets</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">bulletPtr</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">bulletPtr</span><span class="o">-&gt;</span><span class="n">m_data</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">bulletPtr</span><span class="o">-&gt;</span><span class="n">m_data</span><span class="o">-&gt;</span><span class="n">img</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bulletPtr</span><span class="o">-&gt;</span><span class="n">drawBullet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskEXIT_CRITICAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//清除所有实体，资源回收
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">clearAllEntities</span><span class="p">(</span><span class="kt">bool</span> <span class="n">deleteObjects</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanUpAllRoles</span><span class="p">(</span><span class="n">deleteObjects</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanUpAllBullets</span><span class="p">(</span><span class="n">deleteObjects</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//清除所有角色和子弹，资源回收
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">cleanUpAllRoles</span><span class="p">(</span><span class="kt">bool</span> <span class="n">deleteObjects</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deleteObjects</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">rolePtr</span> <span class="p">:</span> <span class="n">m_roles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">rolePtr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">delete</span> <span class="n">rolePtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_roles</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">cleanUpAllBullets</span><span class="p">(</span><span class="kt">bool</span> <span class="n">deleteObjects</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deleteObjects</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bulletPtr</span> <span class="p">:</span> <span class="n">m_bullets</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">bulletPtr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">delete</span> <span class="n">bulletPtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_bullets</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//玩家角色获取经验值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">gainDropExperiencePoints</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">points</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LeadingRole</span><span class="o">*</span> <span class="n">playerRole</span> <span class="o">=</span> <span class="p">(</span><span class="n">LeadingRole</span><span class="o">*</span><span class="p">)</span><span class="n">getPlayerRole</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">playerRole</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">playerRole</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">playerRole</span><span class="o">-&gt;</span><span class="n">experiencePoints</span> <span class="o">+=</span> <span class="n">points</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// GAMEENTITYMANAGER_HPP
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>GameProgressManager</code>负责关卡与波次推进以及 Boss 触发和过场展示：当清场（场上仅剩玩家）时递进波次/关卡，在关键节点触发选卡并按章节规则生成阵型或 Boss，从而把战斗节奏和演出串联起来。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef GAMEPROGRESSMANAGER_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GAMEPROGRESSMANAGER_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;gamePerkCardManager.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">extern</span> <span class="kt">uint8_t</span>             <span class="n">controlDelayTime</span><span class="p">;</span> <span class="c1">// 由 threads.cpp 定义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">GameEntityManager</span>   <span class="n">g_entityManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">GamePerkCardManager</span> <span class="n">g_perkCardManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">WaveType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//魑魅阵型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHIMEI_LINE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// 10 魑魅直线阵
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHIMEI_TRIANGLE</span><span class="p">,</span> <span class="c1">// 10 魑魅三角阵
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//飞廉阵型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">THREE_Feilian</span><span class="p">,</span>   <span class="c1">// 三飞廉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FEILIAN_CLUSTER</span><span class="p">,</span> <span class="c1">// 飞廉群
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//古雕阵型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GUDIAO_SINGLE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">GUODIAO_DOUBLE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">GUDIAO_SQUARE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//混合阵型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MIXED_SMALL</span><span class="p">,</span>  <span class="c1">// 混合小型阵型 2feilian + 1Gudiao
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MIXED_MEDIUM</span><span class="p">,</span> <span class="c1">// 混合中型阵型 5feilian +1Gudiao
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MIXED_LARGE</span><span class="p">,</span>  <span class="c1">// 混合大型阵型 5feilian + 2Gudiao
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">BOSS_TYPE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">TAO_TIE</span><span class="p">,</span>   <span class="c1">// 饕餮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">XIANG_LIU</span><span class="p">,</span> <span class="c1">// 相柳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TAO_WU</span><span class="p">,</span>    <span class="c1">// 梼杌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GameProgressManager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">currentChapter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 当前游戏关卡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">lastChapter</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 最大游戏关卡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">currentWave</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// 当前波次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">maxWave</span>                <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">// 最大波次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">currentChapterMaxWaves</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 当前关卡总波次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">time_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span>     <span class="n">isPlayingOpeningCG</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 是否播放开场动画
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint16_t</span> <span class="n">openingCGTimer</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// 开场动画计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span>     <span class="n">isPlayingClearCG</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 是否播放通关动画
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint16_t</span> <span class="n">clearCGTimer</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// 通关动画计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">chatpter4Warning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 第四章警告标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BOSS_TYPE</span> <span class="n">showWhichBoss</span> <span class="o">=</span> <span class="n">BOSS_TYPE</span><span class="o">::</span><span class="n">NONE</span><span class="p">;</span> <span class="c1">// 展示Boss类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span>      <span class="n">showBoss</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>           <span class="c1">// 是否 展示Boss海报
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint16_t</span>  <span class="n">showBossTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>               <span class="c1">// 展示Boss海报计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//播放3秒Boss海报
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">PauseGame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 暂停游戏标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">GameProgressManager</span><span class="p">()</span>  <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">GameProgressManager</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GameProgressManager</span><span class="p">(</span><span class="k">const</span> <span class="n">GameProgressManager</span> <span class="o">&amp;</span><span class="p">)</span>            <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GameProgressManager</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">GameProgressManager</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 重置游戏进度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="n">resetGameProgress</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 重置实体管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新游戏进度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">updateGameProgress</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">AddWaveEnemies</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绘图展示功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 绘制开场动画
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">drawOpeningCG</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">openingCGTimer</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">controlDelayTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">openingCGTimer</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">controlDelayTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">isPlayingOpeningCG</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 绘制动态圆圈效果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OLED_DrawCircle</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">30</span> <span class="o">-</span> <span class="p">(</span><span class="n">openingCGTimer</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">OLED_DrawCircle</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">20</span> <span class="o">-</span> <span class="p">(</span><span class="n">openingCGTimer</span> <span class="o">/</span> <span class="mi">150</span><span class="p">)</span><span class="o">+</span><span class="mi">30</span> <span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">OLED_PrintString</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="s">&#34;CHIP TANKS&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font8x6</span><span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">drawClearCG</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">clearCGTimer</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">controlDelayTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">clearCGTimer</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">controlDelayTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">isPlayingClearCG</span>           <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">g_entityManager</span><span class="p">.</span><span class="n">isGameOver</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// 游戏结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 致谢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OLED_PrintString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="s">&#34;THANK YOU FOR&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font8x6</span><span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">OLED_PrintString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s">&#34;PLAYING MY GAME&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font8x6</span><span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绘制展示Boss海报
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">drawShowBoss</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// GAMEPROGRESSMANAGER_HPP
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>GamePerkCardManager</code>管理 Roguelike 式成长：基于配置初始化卡片仓库，按需抽取待选卡、应用所选增益到玩家并回库未选卡，同时提供选卡界面渲染与交互状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef GAMEPERKCARDMANAGER_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GAMEPERKCARDMANAGER_HPP
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;etl/vector.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;oled.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;prekCard.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;gameEntityManager.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;leadingRole.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 管理游戏中的Perk卡片系统
</span></span></span><span class="line"><span class="cl"><span class="c1">// 引用GameEntityManager实例
</span></span></span><span class="line"><span class="cl"><span class="c1">// 归gameProgressManager管理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">GameEntityManager</span> <span class="n">g_entityManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GamePerkCardManager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">GamePerkCardManager</span><span class="p">()</span>  <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">GamePerkCardManager</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GamePerkCardManager</span><span class="p">(</span><span class="k">const</span> <span class="n">GamePerkCardManager</span> <span class="o">&amp;</span><span class="p">)</span>            <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GamePerkCardManager</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">GamePerkCardManager</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">MAX_CARD_COUNT</span>       <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="c1">// 总卡片数（2*10 +1*2=22）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">SELECTION_SLOT_COUNT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="c1">// 选卡槽数量（3张）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PerkCard</span><span class="p">,</span> <span class="n">MAX_CARD_COUNT</span><span class="o">&gt;</span>       <span class="n">m_cardWarehouse</span><span class="p">;</span>  <span class="c1">// 卡片仓库（存所有卡片）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">etl</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PerkCard</span><span class="p">,</span> <span class="n">SELECTION_SLOT_COUNT</span><span class="o">&gt;</span> <span class="n">m_selectionSlots</span><span class="p">;</span> <span class="c1">// 选卡槽（临时存3张待选）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span>    <span class="n">isInited</span>        <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 是否已初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span>    <span class="n">m_isSelecting</span>   <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 选卡状态（标记是否处于“选卡中”，避免重复触发）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">m_selectedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// 选中卡片索引（选卡槽内索引）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">m_selectedSize</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// 选中卡片数量（选卡槽内数量）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化卡片仓库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="n">initWarehouse</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_isSelecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">isInited</span>      <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 遍历配置表，按数量创建卡片并加入仓库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">config</span> <span class="p">:</span> <span class="n">PERK_CARD_CONFIGS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PerkCard</span> <span class="nf">newCard</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">newCard</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">triggerPerkSelection</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_isSelecting</span> <span class="o">||</span> <span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 已在选卡中或无卡片可选，拒绝触发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 可用卡片不足3张时，取全部（避免选卡槽为空）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint8_t</span> <span class="n">selectCount</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">SELECTION_SLOT_COUNT</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">selectCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 无可用卡片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_selectedSize</span> <span class="o">=</span> <span class="n">selectCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 随机抽取selectCount张卡片，放入选卡槽（从仓库移除，避免重复抽）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">selectCount</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 嵌入式随机算法：用系统滴答定时器做模运算（无需rand()）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">uint8_t</span> <span class="n">randIdx</span>      <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8_t</span> <span class="n">warehouseIdx</span> <span class="o">=</span> <span class="n">randIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 从仓库移动到选卡槽（避免拷贝，提升效率）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">m_cardWarehouse</span><span class="p">[</span><span class="n">warehouseIdx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">warehouseIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 标记为选卡中，UI提示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">m_isSelecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">selectCard</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">slotIndex</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 前置校验：1. 在选卡中；2. 槽索引有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_isSelecting</span> <span class="o">||</span> <span class="n">slotIndex</span> <span class="o">&gt;=</span> <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理选中卡片（slotIndex）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PerkCard</span>     <span class="n">selectedCard</span> <span class="o">=</span> <span class="n">m_selectionSlots</span><span class="p">[</span><span class="n">slotIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">LeadingRole</span> <span class="o">*</span><span class="n">player</span>       <span class="o">=</span> <span class="p">(</span><span class="n">LeadingRole</span> <span class="o">*</span><span class="p">)</span><span class="n">g_entityManager</span><span class="p">.</span><span class="n">getPlayerRole</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 未找到玩家角色，无法应用卡片效果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 应用卡片效果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">switch</span> <span class="p">(</span><span class="n">selectedCard</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">HEAL_SPEED_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healSpeed</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">HEAL_AMOUNT_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">healValue</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">HEALTH_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">maxHealth</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">currentHealth</span> <span class="o">=</span> <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">healthData</span><span class="p">.</span><span class="n">maxHealth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">ATTACK_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">attackPower</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">ATTACK_SPEED_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">shootCooldownSpeed</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">HEAT_CAPACITY_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">maxHeat</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">HEAT_COOL_DOWN_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">heatData</span><span class="p">.</span><span class="n">heatCoolDownRate</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">UNLOCK_FIREBALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">bulletTypeOwned</span><span class="p">.</span><span class="n">fireBallBulletOwed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">UNLOCK_LIGHTNING</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">bulletTypeOwned</span><span class="p">.</span><span class="n">lightningLineBulletOwed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">FIREBALL_RANGE_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">bulletRange</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">LIGHTNING_MULTIPLIER_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">attackData</span><span class="p">.</span><span class="n">bulletDamageMultiplier</span> <span class="o">+=</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">PerkCardType</span><span class="o">::</span><span class="nl">MOVE_SPEED_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">player</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">spatialData</span><span class="p">.</span><span class="n">moveSpeed</span> <span class="o">+=</span> <span class="n">selectedCard</span><span class="p">.</span><span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 移除选中卡片，清理未选中卡片，重置选卡状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">slotIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">returnUnselectedCards</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_isSelecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 辅助接口：未选中的卡片回库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">returnUnselectedCards</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 跳过选中的卡片（slotIndex已处理）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">m_cardWarehouse</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">m_selectionSlots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">drawSelectionUI</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_isSelecting</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span> <span class="c1">// 非选卡状态，无需绘制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 绘制选卡槽UI（简化示例，实际根据UI框架实现）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m_selectionSlots</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">OLED_PrintString</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">20</span><span class="p">),</span> <span class="n">m_selectionSlots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font8x6</span><span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">OLED_DrawCircle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">m_selectedIndex</span> <span class="o">*</span> <span class="mi">20</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">OLED_COLOR_NORMAL</span><span class="p">);</span> <span class="c1">// 绘制选中指示器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// GAMEPERKCARDMANAGER_HPP
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="应用逻辑层-1">应用逻辑层
</h4><p>按“主循环驱动、输入分发、渲染输出”三类职责拆分成独立的 FreeRTOS 任务，全局状态作为门控，保证在过场、选卡、战斗三种模式之间平滑切换。</p>
<p>核心数据与行为推进集中在  <code>gameControlThread</code>，输入解析与状态写入在  <code>keyScanThread</code>，画面组合与输出在  <code>oledTaskThread</code>。</p>
<p>给出伪代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="nl">oledTaskThread</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">初始化</span><span class="o">:</span> <span class="n">delay</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="err">→</span> <span class="n">OLED_Init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">每帧</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">OLED_NewFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">若</span> <span class="o">!</span><span class="n">g_entityManager</span><span class="p">.</span><span class="nl">isGameOver</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">若</span> <span class="n">g_progressManager</span><span class="p">.</span><span class="nl">isPlayingOpeningCG</span><span class="p">:</span> <span class="n">drawOpeningCG</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">否则若</span> <span class="n">g_progressManager</span><span class="p">.</span><span class="nl">isPlayingClearCG</span><span class="p">:</span> <span class="n">drawClearCG</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">否则若</span> <span class="n">g_progressManager</span><span class="p">.</span><span class="nl">showBoss</span><span class="p">:</span> <span class="n">drawShowBoss</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">否则若</span> <span class="n">g_perkCardManager</span><span class="p">.</span><span class="n">m_isSelecting</span> <span class="o">&amp;&amp;</span> <span class="n">g_perkCardManager</span><span class="p">.</span><span class="nl">isInited</span><span class="p">:</span> <span class="n">drawSelectionUI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">否则（战斗界面）</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="err">若玩家存在</span><span class="o">:</span> <span class="n">drawPlayerHUD</span><span class="p">(</span><span class="n">HP</span><span class="p">,</span> <span class="n">LV</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">g_entityManager</span><span class="p">.</span><span class="n">drawAllRoles</span><span class="p">()</span><span class="err">；</span><span class="n">g_entityManager</span><span class="p">.</span><span class="n">drawAllBullets</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">OLED_ShowFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">delay</span><span class="p">(</span><span class="n">controlDelayTime</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">keyScanThread</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">初始化</span><span class="o">:</span> <span class="n">scanDelay</span><span class="o">=</span><span class="mi">40</span> <span class="err">→</span> <span class="n">key</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">每轮</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span><span class="p">.</span><span class="n">scan</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">若游戏进行中（非</span> <span class="n">GameOver</span><span class="o">/</span><span class="err">开场</span><span class="o">/</span><span class="n">Boss</span> <span class="err">展示</span><span class="o">/</span><span class="err">通关）</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="err">若</span> <span class="o">!</span><span class="n">g_perkCardManager</span><span class="p">.</span><span class="n">m_isSelecting</span><span class="err">（战斗输入态）</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">scanDelay</span><span class="o">=</span><span class="mi">40</span>
</span></span><span class="line"><span class="cl"><span class="n">pLeadingRole</span> <span class="o">=</span> <span class="p">(</span><span class="n">LeadingRole</span><span class="o">*</span><span class="p">)</span> <span class="n">g_entityManager</span><span class="p">.</span><span class="n">getPlayerRole</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">若玩家存在</span><span class="o">:</span> <span class="err">按键映射到动作态与方向（</span><span class="n">LEFT</span><span class="o">/</span><span class="n">DOWN</span><span class="o">/</span><span class="n">UP</span><span class="o">/</span><span class="n">RIGHT</span> <span class="err">→</span> <span class="n">ActionState</span><span class="o">::</span><span class="n">MOVING</span> <span class="o">+</span> <span class="n">MoveMode</span><span class="err">）</span>
</span></span><span class="line"><span class="cl"><span class="err">否则（选卡输入态）</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">scanDelay</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="err">光标索引在</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">m_selectedSize</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="err">间夹紧</span>
</span></span><span class="line"><span class="cl"><span class="n">keyDown</span> <span class="err">→</span> <span class="err">索引</span><span class="o">+</span><span class="mi">1</span><span class="err">（上限保护）；</span><span class="n">keyUp</span> <span class="err">→</span> <span class="err">索引</span><span class="o">-</span><span class="mi">1</span><span class="err">（下限保护）</span>
</span></span><span class="line"><span class="cl"><span class="n">keyConfirm</span> <span class="err">→</span> <span class="n">g_perkCardManager</span><span class="p">.</span><span class="n">selectCard</span><span class="p">(</span><span class="n">m_selectedIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delay</span><span class="p">(</span><span class="n">scanDelay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">gameControlThread</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">启动</span><span class="o">:</span> <span class="n">g_entityManager</span><span class="p">.</span><span class="n">isGameOver</span> <span class="o">=</span> <span class="nb">true</span><span class="err">（强制初始重置）</span>
</span></span><span class="line"><span class="cl"><span class="err">每轮</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="err">若</span> <span class="n">g_entityManager</span><span class="p">.</span><span class="nl">isGameOver</span><span class="p">:</span> <span class="n">g_progressManager</span><span class="p">.</span><span class="n">resetGameProgress</span><span class="p">()</span><span class="err">（清空实体→添加玩家→初始化卡池→开场动画计时）</span>
</span></span><span class="line"><span class="cl"><span class="err">否则若逻辑可推进（非开场</span><span class="o">/</span><span class="err">非</span><span class="n">Boss展示</span><span class="o">/</span><span class="err">非通关</span><span class="o">/</span><span class="err">非选卡）</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="err">进度推进</span><span class="o">:</span> <span class="n">g_progressManager</span><span class="p">.</span><span class="n">updateGameProgress</span><span class="p">()</span><span class="err">（清场判定→波次</span><span class="o">/</span><span class="err">关卡递进→半程</span><span class="o">/</span><span class="err">过关触发选卡→</span><span class="n">AddWaveEnemies</span><span class="p">()</span><span class="err">）</span>
</span></span><span class="line"><span class="cl"><span class="err">行为阶段</span><span class="o">:</span> <span class="n">g_entityManager</span><span class="p">.</span><span class="n">updateAllRolesActions</span><span class="p">()</span><span class="err">；</span><span class="n">g_entityManager</span><span class="p">.</span><span class="n">updateAllBulletsActions</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">状态阶段</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">g_entityManager</span><span class="p">.</span><span class="n">updateAllRolesState</span><span class="p">()</span><span class="err">（</span><span class="n">AABB碰撞</span><span class="err">→方向判定→位移</span><span class="o">/</span><span class="err">回退→冷却</span><span class="o">/</span><span class="err">热量</span><span class="o">/</span><span class="err">回血→玩家</span> <span class="n">levelUp</span><span class="p">()</span><span class="err">）</span>
</span></span><span class="line"><span class="cl"><span class="n">g_entityManager</span><span class="p">.</span><span class="n">updateAllBulletsState</span><span class="p">()</span><span class="err">（命中检测→范围伤害→位移</span><span class="o">/</span><span class="err">寿命）</span>
</span></span><span class="line"><span class="cl"><span class="err">清理阶段</span><span class="o">:</span> <span class="n">cleanupInvalidRoles</span><span class="p">()</span><span class="err">（敌人死亡发经验、玩家死亡置</span> <span class="n">GameOver</span><span class="err">）；</span><span class="n">cleanupInvalidBullets</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">delay</span><span class="p">(</span><span class="n">controlDelayTime</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="timer-定时器的设计">timer 定时器的设计
</h4><p>代码比较重点一个设计在于 timer 计时器，每一帧增加或减少帧间隔的时间（相当于决定多少帧触发某一个动作，可以用此来作为一个门控）</p>
<ul>
<li>shootCooldownTimer：射击冷却倒计时，归零前禁止再次开火。</li>
<li>heatCoolDownTimer：热量冷却触发间隔计时，累计到阈值（200ms）降低一次热量。</li>
<li>healTimeCounter：被动回血累积时间，达到阈值（healResetTime）回复 healValue。</li>
<li>deathTimer：死亡后保留与动画展示时间窗，便于延迟清理。</li>
<li>consecutiveCollisionCount（计数型“时间替代”）：连续帧碰撞累计，扩大回退步幅直至解除。</li>
<li>action_timer（敌人/技能内部使用）：驱动攻击模式阶段切换与技能节拍。</li>
<li>openingCGTimer / clearCGTimer / showBossTimer（过场类）：控制开场、通关、Boss 展示持续时间。</li>
<li>shootCooldownResetTime / healResetTime 等“阈值型常量”：定义倒计时起点或触发周期长度。</li>
</ul>
<p><strong>核心：所有计时器是“离散步长 + 阈值触发”模型</strong>
增加每一帧的<code>controlDelayTime</code>，用统一帧步长驱动一组简单的线性计时器，以门槛触发和双重约束塑造节奏与资源循环</p>
<p><strong>核心作用</strong>：<strong>解耦时间进程和行为</strong>，计时器只管理时间进程，不直接耦合行为；行为在触发点读取状态执行。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/cc&#43;&#43;/">C&amp;C&#43;&#43;</a>
        
            <a href="/tags/%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE/">个人项目</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/chiptanks-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1/">
        
        

        <div class="article-details">
            <h2 class="article-title">ChipTanks-游戏设计</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/chiptanks-%E7%8E%A9%E6%B3%95%E4%BB%8B%E7%BB%8D/">
        
        

        <div class="article-details">
            <h2 class="article-title">ChipTanks-玩法介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/cc-%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/">
        
        

        <div class="article-details">
            <h2 class="article-title">C&amp;C&#43;&#43; 系统学习</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/c-%E9%87%8D%E8%BD%BD/">
        
        

        <div class="article-details">
            <h2 class="article-title">C&#43;&#43; 重载</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/c-%E5%BC%95%E7%94%A8/">
        
        

        <div class="article-details">
            <h2 class="article-title">C&#43;&#43; 引用</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Nomad
    </section>
    
    <section class="powerby">
        
            experience <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
